<?xml version="1.0" encoding="UTF-8"?>
<transformation>
  <info>
    <name>PL_FPD_Surplus_for_Tableau_stage</name>
    <description />
    <extended_description />
    <trans_version />
    <trans_type>Normal</trans_type>
    <trans_status>0</trans_status>
    <directory>/</directory>
    <parameters>
    </parameters>
    <log>
      <trans-log-table>
        <connection />
        <schema />
        <table />
        <size_limit_lines />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STATUS</id>
          <enabled>Y</enabled>
          <name>STATUS</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
          <subject />
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
          <subject />
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
          <subject />
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
          <subject />
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
          <subject />
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>STARTDATE</id>
          <enabled>Y</enabled>
          <name>STARTDATE</name>
        </field>
        <field>
          <id>ENDDATE</id>
          <enabled>Y</enabled>
          <name>ENDDATE</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>DEPDATE</id>
          <enabled>Y</enabled>
          <name>DEPDATE</name>
        </field>
        <field>
          <id>REPLAYDATE</id>
          <enabled>Y</enabled>
          <name>REPLAYDATE</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>Y</enabled>
          <name>LOG_FIELD</name>
        </field>
        <field>
          <id>EXECUTING_SERVER</id>
          <enabled>N</enabled>
          <name>EXECUTING_SERVER</name>
        </field>
        <field>
          <id>EXECUTING_USER</id>
          <enabled>N</enabled>
          <name>EXECUTING_USER</name>
        </field>
        <field>
          <id>CLIENT</id>
          <enabled>N</enabled>
          <name>CLIENT</name>
        </field>
      </trans-log-table>
      <perf-log-table>
        <connection />
        <schema />
        <table />
        <interval />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>SEQ_NR</id>
          <enabled>Y</enabled>
          <name>SEQ_NR</name>
        </field>
        <field>
          <id>LOGDATE</id>
          <enabled>Y</enabled>
          <name>LOGDATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>INPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>INPUT_BUFFER_ROWS</name>
        </field>
        <field>
          <id>OUTPUT_BUFFER_ROWS</id>
          <enabled>Y</enabled>
          <name>OUTPUT_BUFFER_ROWS</name>
        </field>
      </perf-log-table>
      <channel-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>LOGGING_OBJECT_TYPE</id>
          <enabled>Y</enabled>
          <name>LOGGING_OBJECT_TYPE</name>
        </field>
        <field>
          <id>OBJECT_NAME</id>
          <enabled>Y</enabled>
          <name>OBJECT_NAME</name>
        </field>
        <field>
          <id>OBJECT_COPY</id>
          <enabled>Y</enabled>
          <name>OBJECT_COPY</name>
        </field>
        <field>
          <id>REPOSITORY_DIRECTORY</id>
          <enabled>Y</enabled>
          <name>REPOSITORY_DIRECTORY</name>
        </field>
        <field>
          <id>FILENAME</id>
          <enabled>Y</enabled>
          <name>FILENAME</name>
        </field>
        <field>
          <id>OBJECT_ID</id>
          <enabled>Y</enabled>
          <name>OBJECT_ID</name>
        </field>
        <field>
          <id>OBJECT_REVISION</id>
          <enabled>Y</enabled>
          <name>OBJECT_REVISION</name>
        </field>
        <field>
          <id>PARENT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>PARENT_CHANNEL_ID</name>
        </field>
        <field>
          <id>ROOT_CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>ROOT_CHANNEL_ID</name>
        </field>
      </channel-log-table>
      <step-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>TRANSNAME</id>
          <enabled>Y</enabled>
          <name>TRANSNAME</name>
        </field>
        <field>
          <id>STEPNAME</id>
          <enabled>Y</enabled>
          <name>STEPNAME</name>
        </field>
        <field>
          <id>STEP_COPY</id>
          <enabled>Y</enabled>
          <name>STEP_COPY</name>
        </field>
        <field>
          <id>LINES_READ</id>
          <enabled>Y</enabled>
          <name>LINES_READ</name>
        </field>
        <field>
          <id>LINES_WRITTEN</id>
          <enabled>Y</enabled>
          <name>LINES_WRITTEN</name>
        </field>
        <field>
          <id>LINES_UPDATED</id>
          <enabled>Y</enabled>
          <name>LINES_UPDATED</name>
        </field>
        <field>
          <id>LINES_INPUT</id>
          <enabled>Y</enabled>
          <name>LINES_INPUT</name>
        </field>
        <field>
          <id>LINES_OUTPUT</id>
          <enabled>Y</enabled>
          <name>LINES_OUTPUT</name>
        </field>
        <field>
          <id>LINES_REJECTED</id>
          <enabled>Y</enabled>
          <name>LINES_REJECTED</name>
        </field>
        <field>
          <id>ERRORS</id>
          <enabled>Y</enabled>
          <name>ERRORS</name>
        </field>
        <field>
          <id>LOG_FIELD</id>
          <enabled>N</enabled>
          <name>LOG_FIELD</name>
        </field>
      </step-log-table>
      <metrics-log-table>
        <connection />
        <schema />
        <table />
        <timeout_days />
        <field>
          <id>ID_BATCH</id>
          <enabled>Y</enabled>
          <name>ID_BATCH</name>
        </field>
        <field>
          <id>CHANNEL_ID</id>
          <enabled>Y</enabled>
          <name>CHANNEL_ID</name>
        </field>
        <field>
          <id>LOG_DATE</id>
          <enabled>Y</enabled>
          <name>LOG_DATE</name>
        </field>
        <field>
          <id>METRICS_DATE</id>
          <enabled>Y</enabled>
          <name>METRICS_DATE</name>
        </field>
        <field>
          <id>METRICS_CODE</id>
          <enabled>Y</enabled>
          <name>METRICS_CODE</name>
        </field>
        <field>
          <id>METRICS_DESCRIPTION</id>
          <enabled>Y</enabled>
          <name>METRICS_DESCRIPTION</name>
        </field>
        <field>
          <id>METRICS_SUBJECT</id>
          <enabled>Y</enabled>
          <name>METRICS_SUBJECT</name>
        </field>
        <field>
          <id>METRICS_TYPE</id>
          <enabled>Y</enabled>
          <name>METRICS_TYPE</name>
        </field>
        <field>
          <id>METRICS_VALUE</id>
          <enabled>Y</enabled>
          <name>METRICS_VALUE</name>
        </field>
      </metrics-log-table>
    </log>
    <maxdate>
      <connection />
      <table />
      <field />
      <offset>0.0</offset>
      <maxdiff>0.0</maxdiff>
    </maxdate>
    <size_rowset>10000</size_rowset>
    <sleep_time_empty>50</sleep_time_empty>
    <sleep_time_full>50</sleep_time_full>
    <unique_connections>N</unique_connections>
    <feedback_shown>Y</feedback_shown>
    <feedback_size>50000</feedback_size>
    <using_thread_priorities>Y</using_thread_priorities>
    <shared_objects_file />
    <capture_step_performance>N</capture_step_performance>
    <step_performance_capturing_delay>1000</step_performance_capturing_delay>
    <step_performance_capturing_size_limit>100</step_performance_capturing_size_limit>
    <dependencies>
    </dependencies>
    <partitionschemas>
    </partitionschemas>
    <slaveservers>
    </slaveservers>
    <clusterschemas>
    </clusterschemas>
    <created_user>-</created_user>
    <created_date>2017/01/31 16:11:01.103</created_date>
    <modified_user>-</modified_user>
    <modified_date>2017/08/14 09:13:16.135</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
    <notepad>
      <note>MUCH SLOWER</note>
      <xloc>640</xloc>
      <yloc>64</yloc>
      <width>135</width>
      <heigth>34</heigth>
      <fontname>Segoe UI</fontname>
      <fontsize>9</fontsize>
      <fontbold>N</fontbold>
      <fontitalic>N</fontitalic>
      <fontcolorred>0</fontcolorred>
      <fontcolorgreen>0</fontcolorgreen>
      <fontcolorblue>0</fontcolorblue>
      <backgroundcolorred>255</backgroundcolorred>
      <backgroundcolorgreen>205</backgroundcolorgreen>
      <backgroundcolorblue>112</backgroundcolorblue>
      <bordercolorred>100</bordercolorred>
      <bordercolorgreen>100</bordercolorgreen>
      <bordercolorblue>100</bordercolorblue>
      <drawshadow>Y</drawshadow>
    </notepad>
  </notepads>
  <connection>
    <name>PL_Slave_Finotech</name>
    <server>146.148.18.192</server>
    <type>POSTGRESQL</type>
    <access>Native</access>
    <database>poland_prod</database>
    <port>5432</port>
    <username>maciej</username>
    <password>Encrypted 5831346d5434776f6b7367756b747464d8d0e6be58c085d39c00bd65ee9fa7ea</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>5432</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <connection>
    <name>Tanikredyt_reporting_DB_TEST</name>
    <server>10.10.99.8</server>
    <type>POSTGRESQL</type>
    <access>Native</access>
    <database>tanikredyt</database>
    <port>5432</port>
    <username>maciej</username>
    <password>Encrypted 2be98afc86aa7f2aebe0f877adf81a78f</password>
    <servername />
    <data_tablespace />
    <index_tablespace />
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_UPPERCASE</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>IS_CLUSTERED</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>PORT_NUMBER</code>
        <attribute>5432</attribute>
      </attribute>
      <attribute>
        <code>PRESERVE_RESERVED_WORD_CASE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>QUOTE_ALL_FIELDS</code>
        <attribute>N</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_BOOLEAN_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>SUPPORTS_TIMESTAMP_DATA_TYPE</code>
        <attribute>Y</attribute>
      </attribute>
      <attribute>
        <code>USE_POOLING</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <order>
    <hop>
      <from>get loans</from>
      <to>Database join</to>
      <enabled>N</enabled>
    </hop>
    <hop>
      <from>Database join</from>
      <to>filter on cession deal</to>
      <enabled>N</enabled>
    </hop>
    <hop>
      <from>filter on cession deal</from>
      <to>merge</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>merge</from>
      <to>push to loan_main</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>filter on cession deal</from>
      <to>set status to sold</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>set status to sold</from>
      <to>merge</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Lindorff sold</from>
      <to>Sort rows</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>get loans</from>
      <to>Sort rows 2</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Sort rows</from>
      <to>Multiway Merge Join</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Sort rows 2</from>
      <to>Multiway Merge Join</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Multiway Merge Join</from>
      <to>filter on cession deal</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <step>
    <name>Database join</name>
    <type>DBJoin</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>Tanikredyt_reporting_DB_TEST</connection>
    <rowlimit>0</rowlimit>
    <sql>select * from loan_lindorff_test1

where id = ?</sql>
    <outer_join>Y</outer_join>
    <replace_vars>N</replace_vars>
    <parameter>
      <field>
        <name>loan_id</name>
        <type>String</type>
      </field>
    </parameter>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>688</xloc>
      <yloc>96</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>merge</name>
    <type>Dummy</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>928</xloc>
      <yloc>192</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>filter on cession deal</name>
    <type>FilterRows</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <send_true_to>set status to sold</send_true_to>
    <send_false_to>merge</send_false_to>
    <compare>
      <condition>
        <negated>N</negated>
        <leftvalue>cessiondeal</leftvalue>
        <function>IS NOT NULL</function>
        <rightvalue />
      </condition>
    </compare>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>848</xloc>
      <yloc>272</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Lindorff sold</name>
    <type>TableInput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>Tanikredyt_reporting_DB_TEST</connection>
    <sql>SELECT * from loan_lindorff_sold</sql>
    <limit>0</limit>
    <lookup />
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>352</xloc>
      <yloc>256</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Multiway Merge Join</name>
    <type>MultiwayMergeJoin</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <join_type>FULL OUTER</join_type>
    <step0>Sort rows</step0>
    <step1>Sort rows 2</step1>
    <number_input>2</number_input>
    <keys>
      <key>id</key>
      <key>loan_id</key>
    </keys>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>688</xloc>
      <yloc>224</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>set status to sold</name>
    <type>SetValueConstant</type>
    <description />
    <distribute>N</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <usevar>N</usevar>
    <fields>
      <field>
        <name>status</name>
        <value>sold</value>
        <mask />
        <set_empty_string>N</set_empty_string>
      </field>
    </fields>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>976</xloc>
      <yloc>272</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Sort rows</name>
    <type>SortRows</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <directory>%%java.io.tmpdir%%</directory>
    <prefix>out</prefix>
    <sort_size>1000000</sort_size>
    <free_memory />
    <compress>N</compress>
    <compress_variable />
    <unique_rows>N</unique_rows>
    <fields>
      <field>
        <name>id</name>
        <ascending>Y</ascending>
        <case_sensitive>N</case_sensitive>
        <collator_enabled>N</collator_enabled>
        <collator_strength>0</collator_strength>
        <presorted>N</presorted>
      </field>
    </fields>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>448</xloc>
      <yloc>256</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>Sort rows 2</name>
    <type>SortRows</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <directory>%%java.io.tmpdir%%</directory>
    <prefix>out</prefix>
    <sort_size>1000000</sort_size>
    <free_memory />
    <compress>N</compress>
    <compress_variable />
    <unique_rows>N</unique_rows>
    <fields>
      <field>
        <name>loan_id</name>
        <ascending>Y</ascending>
        <case_sensitive>N</case_sensitive>
        <collator_enabled>N</collator_enabled>
        <collator_strength>0</collator_strength>
        <presorted>N</presorted>
      </field>
    </fields>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>592</xloc>
      <yloc>176</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>push to loan_main</name>
    <type>TableOutput</type>
    <description />
    <distribute>Y</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>Tanikredyt_reporting_DB_TEST</connection>
    <schema />
    <table>loan_main</table>
    <commit>5000</commit>
    <truncate>Y</truncate>
    <ignore_errors>N</ignore_errors>
    <use_batch>Y</use_batch>
    <specify_fields>Y</specify_fields>
    <partitioning_enabled>N</partitioning_enabled>
    <partitioning_field />
    <partitioning_daily>N</partitioning_daily>
    <partitioning_monthly>Y</partitioning_monthly>
    <tablename_in_field>N</tablename_in_field>
    <tablename_field />
    <tablename_in_table>Y</tablename_in_table>
    <return_keys>N</return_keys>
    <return_field />
    <fields>
      <field>
        <column_name>loan_id</column_name>
        <stream_name>loan_id</stream_name>
      </field>
      <field>
        <column_name>cessiondeal</column_name>
        <stream_name>cessiondeal</stream_name>
      </field>
      <field>
        <column_name>extensions</column_name>
        <stream_name>extensions</stream_name>
      </field>
      <field>
        <column_name>interest_due</column_name>
        <stream_name>interest_due</stream_name>
      </field>
      <field>
        <column_name>issue_date</column_name>
        <stream_name>issue_date</stream_name>
      </field>
      <field>
        <column_name>maturity_date</column_name>
        <stream_name>maturity_date</stream_name>
      </field>
      <field>
        <column_name>close_date</column_name>
        <stream_name>close_date</stream_name>
      </field>
      <field>
        <column_name>penalty_due</column_name>
        <stream_name>penalty_due</stream_name>
      </field>
      <field>
        <column_name>period_count</column_name>
        <stream_name>period_count</stream_name>
      </field>
      <field>
        <column_name>principal_due</column_name>
        <stream_name>principal_due</stream_name>
      </field>
      <field>
        <column_name>status</column_name>
        <stream_name>status</stream_name>
      </field>
      <field>
        <column_name>total_due</column_name>
        <stream_name>total_due</stream_name>
      </field>
      <field>
        <column_name>client_id</column_name>
        <stream_name>client_id</stream_name>
      </field>
      <field>
        <column_name>time_to_get_loan</column_name>
        <stream_name>time_to_get_loan</stream_name>
      </field>
      <field>
        <column_name>time_to_get_loan_h</column_name>
        <stream_name>time_to_get_loan_h</stream_name>
      </field>
      <field>
        <column_name>requested_period_count</column_name>
        <stream_name>requested_period_count</stream_name>
      </field>
      <field>
        <column_name>cash_in</column_name>
        <stream_name>cash_in</stream_name>
      </field>
      <field>
        <column_name>cash_out</column_name>
        <stream_name>cash_out</stream_name>
      </field>
      <field>
        <column_name>fee</column_name>
        <stream_name>fee</stream_name>
      </field>
      <field>
        <column_name>fee_paid</column_name>
        <stream_name>fee_paid</stream_name>
      </field>
      <field>
        <column_name>fee_written_off</column_name>
        <stream_name>fee_written_off</stream_name>
      </field>
      <field>
        <column_name>interest</column_name>
        <stream_name>interest</stream_name>
      </field>
      <field>
        <column_name>interest_paid</column_name>
        <stream_name>interest_paid</stream_name>
      </field>
      <field>
        <column_name>interest_written_off</column_name>
        <stream_name>interest_written_off</stream_name>
      </field>
      <field>
        <column_name>overpayment_received</column_name>
        <stream_name>overpayment_received</stream_name>
      </field>
      <field>
        <column_name>overpayment_refunded</column_name>
        <stream_name>overpayment_refunded</stream_name>
      </field>
      <field>
        <column_name>overpayment_used</column_name>
        <stream_name>overpayment_used</stream_name>
      </field>
      <field>
        <column_name>penalty</column_name>
        <stream_name>penalty</stream_name>
      </field>
      <field>
        <column_name>penalty_paid</column_name>
        <stream_name>penalty_paid</stream_name>
      </field>
      <field>
        <column_name>penalty_written_off</column_name>
        <stream_name>penalty_written_off</stream_name>
      </field>
      <field>
        <column_name>principal</column_name>
        <stream_name>principal</stream_name>
      </field>
      <field>
        <column_name>principal_paid</column_name>
        <stream_name>principal_paid</stream_name>
      </field>
      <field>
        <column_name>principal_written_off</column_name>
        <stream_name>principal_written_off</stream_name>
      </field>
      <field>
        <column_name>first_payment_date</column_name>
        <stream_name>first_payment_date</stream_name>
      </field>
      <field>
        <column_name>last_payment_date</column_name>
        <stream_name>last_payment_date</stream_name>
      </field>
      <field>
        <column_name>issue_week</column_name>
        <stream_name>issue_week</stream_name>
      </field>
      <field>
        <column_name>dpd</column_name>
        <stream_name>dpd</stream_name>
      </field>
      <field>
        <column_name>is_due</column_name>
        <stream_name>is_due</stream_name>
      </field>
      <field>
        <column_name>surplus_contract</column_name>
        <stream_name>surplus_contract</stream_name>
      </field>
      <field>
        <column_name>surplus_contract_perc</column_name>
        <stream_name>surplus_contract_perc</stream_name>
      </field>
      <field>
        <column_name>surplus_fact</column_name>
        <stream_name>surplus_fact</stream_name>
      </field>
      <field>
        <column_name>surplus_fact_perc</column_name>
        <stream_name>surplus_fact_perc</stream_name>
      </field>
      <field>
        <column_name>surplus_potential_0days</column_name>
        <stream_name>surplus_potential_0days</stream_name>
      </field>
      <field>
        <column_name>surplus_potential_perc_0days</column_name>
        <stream_name>surplus_potential_perc_0days</stream_name>
      </field>
      <field>
        <column_name>surplus_potential_5days</column_name>
        <stream_name>surplus_potential_5days</stream_name>
      </field>
      <field>
        <column_name>surplus_potential_perc_5days</column_name>
        <stream_name>surplus_potential_perc_5days</stream_name>
      </field>
      <field>
        <column_name>loan_seq</column_name>
        <stream_name>loan_seq</stream_name>
      </field>
      <field>
        <column_name>loan_type</column_name>
        <stream_name>loan_type</stream_name>
      </field>
      <field>
        <column_name>application_week</column_name>
        <stream_name>application_week</stream_name>
      </field>
      <field>
        <column_name>requested_principal</column_name>
        <stream_name>requested_principal</stream_name>
      </field>
      <field>
        <column_name>offered_proportion</column_name>
        <stream_name>offered_proportion</stream_name>
      </field>
      <field>
        <column_name>application_date</column_name>
        <stream_name>application_date</stream_name>
      </field>
      <field>
        <column_name>gender</column_name>
        <stream_name>gender</stream_name>
      </field>
      <field>
        <column_name>prev_dpd</column_name>
        <stream_name>prev_dpd</stream_name>
      </field>
      <field>
        <column_name>loan_application_id</column_name>
        <stream_name>loan_application_id</stream_name>
      </field>
      <field>
        <column_name>extraction_date</column_name>
        <stream_name>extraction_date</stream_name>
      </field>
      <field>
        <column_name>prev_principal</column_name>
        <stream_name>prev_principal</stream_name>
      </field>
      <field>
        <column_name>created_datetime</column_name>
        <stream_name>created_datetime</stream_name>
      </field>
      <field>
        <column_name>resigned</column_name>
        <stream_name>resigned</stream_name>
      </field>
    </fields>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>1088</xloc>
      <yloc>192</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step>
    <name>get loans</name>
    <type>TableInput</type>
    <description />
    <distribute>N</distribute>
    <custom_distribution />
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name />
    </partitioning>
    <connection>PL_Slave_Finotech</connection>
    <sql>with am5 as 

(select loan_id,
max(case when int5 = 0 then sum else 0 end) as surplus0,
max(case when int5 = 5 then sum else 0 end) as surplus5,
max(case when int5 = 10 then sum else 0 end) as surplus10,
max(case when int5 = 15 then sum else 0 end) as surplus15,
max(case when int5 = 20 then sum else 0 end) as surplus20,
max(case when int5 = 25 then sum else 0 end) as surplus25,
max(case when int5 = 30 then sum else 0 end) as surplus30,
max(case when int5 = 35 then sum else 0 end) as surplus35,
max(case when int5 = 40 then sum else 0 end) as surplus40,
max(case when int5 = 45 then sum else 0 end) as surplus45,
max(case when int5 = 50 then sum else 0 end) as surplus50,
max(case when int5 = 55 then sum else 0 end) as surplus55,
max(case when int5 = 60 then sum else 0 end) as surplus60,
max(case when int5 = 61 then sum else 0 end) as surplus61

from	(select loan_id, int5, 
       sum(amount)
from
(select t.id, t.loan_id, --extension_paid +
	 t.fee_paid + t.interest_paid + t.penalty_paid + t.principal_paid as amount,
 case when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 0 then 0
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 5 then 5
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 10 then 10
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 15 then 15
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 20 then 20
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 25 then 25
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 30 then 30
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 35 then 35
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 40 then 40
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 45 then 55
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 50 then 50
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 55 then 55
when t.booking_date::date - (l.issue_date::date+pp.period_count::int) &lt;= 60 then 60 --###### on 05.05.2017 changed from issue_date to term date (issue_date+period_count)
else 61 end as int5

from transaction.transaction t join lending.loan l on (l.id = t.loan_id) join lending.payment_plan pp on (pp.loan_id = l.id and pp.latest = TRUE)
where transaction_type in ('REPAYMENT', 'FEE_PAYMENT') and t.voided = FALSE)pint
group by loan_id, int5)pint_sum group by loan_id)
 

--#### add principal repayments by months similarly as in PL

/*,princ as (select r_loan_id,
max(case when interval30 = 0 then sum else 0 end) as amount_0m,
max(case when interval30 = 1 then sum else 0 end) as amount_1m,
max(case when interval30 = 2 then sum else 0 end) as amount_2m,
max(case when interval30 = 3 then sum else 0 end) as amount_3m,
max(case when interval30 = 4 then sum else 0 end) as amount_4m,
max(case when interval30 = 5 then sum else 0 end) as amount_5m,
max(case when interval30 = 6 then sum else 0 end) as amount_6m,
max(case when interval30 = 7 then sum else 0 end) as amount_7m,
max(case when interval30 = 8 then sum else 0 end) as amount_8m,
max(case when interval30 = 9 then sum else 0 end) as amount_9m,
max(case when interval30 = 10 then sum else 0 end) as amount_10m,
max(case when interval30 = 11 then sum else 0 end) as amount_11m,
max(case when interval30 = 12 then sum else 0 end) as amount_12m,
max(case when interval30 > 12 then sum else 0 end) as amount_13m

from (select r_loan_id, interval30, sum(amount) from (select d.r_loan_id, d.amount_principal as amount,
case when payment_date >= date_trunc('month',(l.loan_date + '0 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '1 month')) then 0
	when payment_date >= date_trunc('month',(l.loan_date + '1 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '2 month')) then 1
	when payment_date >= date_trunc('month',(l.loan_date + '2 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '3 month')) then 2
	when payment_date >= date_trunc('month',(l.loan_date + '3 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '4 month')) then 3
	when payment_date >= date_trunc('month',(l.loan_date + '4 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '5 month')) then 4
	when payment_date >= date_trunc('month',(l.loan_date + '5 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '6 month')) then 5
	when payment_date >= date_trunc('month',(l.loan_date + '6 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '7 month')) then 6
	when payment_date >= date_trunc('month',(l.loan_date + '7 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '8 month')) then 7
	when payment_date >= date_trunc('month',(l.loan_date + '8 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '9 month')) then 8
	when payment_date >= date_trunc('month',(l.loan_date + '9 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '10 month')) then 9
	when payment_date >= date_trunc('month',(l.loan_date + '10 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '11 month')) then 10
	when payment_date >= date_trunc('month',(l.loan_date + '11 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '12 month')) then 11
	when payment_date >= date_trunc('month',(l.loan_date + '12 month')) and payment_date &lt; date_trunc('month',(l.loan_date + '13 month')) then 12
	else 13 end as interval30


from r_payment_distr d join r_payment p on  (d.r_payment_id = p.r_payment_id) join r_loan l on (l.r_loan_id = d.r_loan_id)
	where p.type = 'IN_Loan' and p.cl_bank_acct_id &lt;&gt; 11
)dd		
group by r_loan_id, interval30
order by r_loan_id, interval30)int30

group by r_loan_id) */

--### end of sub selects
select

--lv.*
l.id as loan_id
,l.loan_number
,l.extensions
,case when condition ='RESIGNED' then 1 else null end as resigned
,l.interest_due
,l.issue_date::date
,l.maturity_date::date
,l.close_date::date
,l.loan_number
,l.penalty_due
,l.period_count
,l.principal_due
,case when l.status = 'ACTIVE' and current_date>(pp.maturity_date::date) then 'DELAYED' else l.status end as status 
,l.total_due
,l.client_id
,(l.created_at - la.created_at) as time_to_get_loan
,extract(epoch from ( l.created_at - la.created_at))/3600 as time_to_get_loan_h
,la.requested_period_count
,l.created_at as created_datetime

,trans.*
--,pp.first_repayment_date::date --seems that column has been removed
,pp.maturity_date::date
,pay.first_payment_date
,pay.last_payment_date
,extract(week from l.issue_date) as issue_week --## changed from loan_view.issue_date


--## add days past due (dpd) 
,case when l.status = 'PAID' then pay.last_payment_date-pp.maturity_date::date
	else current_date-pp.maturity_date::date end as dpd



,case when pp.maturity_date > current_date then 'not_yet_due' else 'due' end as is_due

--##surplus from Pl
/*, (l.loan_amount+l.loan_commission)/l.loan_amount*100::double precision as surplus_contract

--##### -dd.amount_surplus added as in cases where out_surplus was not present, calculations were incorrect
, (l.loan_amount+dd.amount-dd.amount_surplus)/l.loan_amount*100::double precision as surplus_fact
*/
,(trans.principal+trans.interest+trans.penalty++trans.fee)::double precision as surplus_contract
,(trans.principal+trans.interest+trans.penalty++trans.fee)/trans.principal::double precision as surplus_contract_perc

--## if paid or delayed 0/3/5 days, then fact, else potential!!!
,(trans.principal_paid+trans.interest_paid+trans.penalty_paid+trans.fee_paid)::double precision as surplus_fact
,(trans.principal_paid+trans.interest_paid+trans.penalty_paid+trans.fee_paid)/trans.principal::double precision as surplus_fact_perc

, case when (l.status = 'PAID' or (current_date-pp.maturity_date::date)>0) then 
(trans.principal_paid+trans.interest_paid+trans.penalty_paid+trans.fee_paid)::double precision 
else (trans.principal+trans.interest+trans.penalty+trans.fee)::double precision end as surplus_potential_0days

, case when (l.status = 'PAID' or (current_date-pp.maturity_date::date)>0) then 
(trans.principal_paid+trans.interest_paid+trans.penalty_paid+trans.fee_paid)/trans.principal::double precision 
else (trans.principal+trans.interest+trans.penalty+trans.fee)/trans.principal::double precision end as surplus_potential_perc_0days

, case when (l.status = 'PAID' or (current_date-pp.maturity_date::date)>5) then 
(trans.principal_paid+trans.interest_paid+trans.penalty_paid+trans.fee_paid)::double precision 
else (trans.principal+trans.interest+trans.penalty+trans.fee)::double precision end as surplus_potential_5days

, case when (l.status = 'PAID' or (current_date-pp.maturity_date::date)>5) then 
(trans.principal_paid+trans.interest_paid+trans.penalty_paid+trans.fee_paid)/trans.principal::double precision 
else (trans.principal+trans.interest+trans.penalty+trans.fee)/trans.principal::double precision end as surplus_potential_perc_5days

,l.loans_paid+1 as loan_seq
,case when l.loans_paid = 0 then 'first' else 'repeated' end as loan_type


,extract(week from la.application_date) as application_week 

,la.requested_principal

,(la.offered_principal / la.requested_principal) as offered_proportion
, current_timestamp as extraction_date



,la.created_at::date as application_date
,case when substring(cc.ektp, 7, 2)::smallint > 40 then 'female' else 'male' end as gender



, (SELECT prev_dpd from (SELECT  COALESCE((SELECT (close_date::date - maturity_date::Date)
       FROM lending.loan ll
       WHERE ll.client_id=l.client_id and ll.issue_date::Date&lt;l.issue_date::date
       ORDER BY created_at DESC
       LIMIT 1), 0)as prev_dpd)pdpd) as prev_dpd
, (SELECT prev_principal from (SELECT  COALESCE((SELECT principal_disbursed
       FROM lending.loan ll
       WHERE ll.client_id=l.client_id and ll.issue_date::Date&lt;l.issue_date::date
       ORDER BY created_at DESC
       LIMIT 1), 0)as prev_principal)pprinc) as prev_principal
,l.loan_application_id


--, (select max_delay from poland_krd.response r where l.loan_application_id = r.loan_application_id order by created_at desc limit 1)max_delay
--, (select providers_count from poland_krd.response r where l.loan_application_id = r.loan_application_id order by created_at desc limit 1)providers_count
--,la.application_date::date - (select last_paid_debt_date::date from poland_krd.response r where l.loan_application_id = r.loan_application_id order by created_at desc limit 1) as dayssincelastpaiddebtkrd


--######### end of selects ###########



from --backoffice.loan_view lv join on (lv.loan_number = l.loan_number)
lending.loan l 
join lending.loan_application la on (l.loan_application_id = la.id)

left outer join
 (select sum(cash_in) as cash_in, sum(cash_out) as cash_out, --sum(extension_paid) as extension_paid, 
	--sum(faulty_in) as faulty_in, sum(faulty_out) as faulty_out, 
      sum(fee_applied) as fee, sum(fee_paid) as fee_paid, sum(fee_written_off) as fee_written_off, 
      sum(interest_applied) as  interest, sum(interest_paid) as interest_paid, 
		sum(interest_written_off) as interest_written_off, loan_id, 
		--sum(other_in) as other_in,   sum(other_out) as other_out, 
		sum(overpayment_received) as overpayment_received, 
		sum(overpayment_refunded) as overpayment_refunded, 
		sum(overpayment_used) as overpayment_used, 
      sum(penalty_applied) as penalty, sum(penalty_paid) as penalty_paid, sum(penalty_written_off) as penalty_written_off, 
      sum(principal_disbursed) as principal, sum(principal_paid) as principal_paid, sum(principal_written_off) as principal_written_off
     -- sum(transfer_in) as transfer_in, sum(transfer_out) as transfer_out

from transaction.transaction where voided = FALSE group by loan_id)trans on (trans.loan_id = l.id)

join lending.payment_plan pp on (pp.loan_id = l.id and pp.latest = TRUE)

left outer join (select min(booking_date)::date as first_payment_date, max(booking_date)::date as last_payment_date, loan_id

from transaction.transaction where transaction_type in ('REPAYMENT', 'FEE_PAYMENT') and voided = FALSE group by loan_id)pay on (l.id = pay.loan_id)

left outer join am5 am5 on (am5.loan_id = l.id)

--### add info on employer verification 
left outer join (select a.attempts, a.resolution, a.status, w.application_id, t.times_postponed, t.times_reopened 
		from workflow.activity a join workflow.workflow w on (a.workflow_id = w.id) left outer join task.task t on (a.id = t.activity_id)
		where a.name = 'EmployerCall')ec on (la.id = ec.application_id) 

left outer join workflow.workflow ww on (ww.id = la.workflow_id)

left outer join (SELECT client_id, json_value::json->>'ektp' as ektp    
      FROM crm.client_attribute 
    where key = 'personalData')cc  on (cc.client_id = l.client_id)

--left outer join (select distinct loan_application_id, scoring from scoring.scorecard_evaluation e join scoring.scorecard s on (e.scorecard_id =  s.id and s.name like 'CREDIT_BUREAU%') 
--order by e.created_at desc limit 1
--)ss on ss.loan_application_id=la.id



left outer join migration_source.r_application msa on (la.id=msa.r_application_id)
left join lending.loan_condition con on con.loan_id=l.id
order by l.id asc</sql>
    <limit>0</limit>
    <lookup />
    <execute_each_row>N</execute_each_row>
    <variables_active>N</variables_active>
    <lazy_conversion_active>N</lazy_conversion_active>
    <cluster_schema />
    <remotesteps>
      <input>
      </input>
      <output>
      </output>
    </remotesteps>
    <GUI>
      <xloc>496</xloc>
      <yloc>112</yloc>
      <draw>Y</draw>
    </GUI>
  </step>
  <step_error_handling>
  </step_error_handling>
  <slave-step-copy-partition-distribution>
  </slave-step-copy-partition-distribution>
  <slave_transformation>N</slave_transformation>
</transformation>
